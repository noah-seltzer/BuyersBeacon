# Server (Backend)

## Overview

The `server` directory contains the ASP.NET Core backend application. It provides a RESTful API for the client, manages data persistence using Entity Framework Core, handles business logic, integrates with Clerk for authentication checks, facilitates real-time chat via SignalR, and interacts with Azure Blob Storage for image handling.

## Key Technologies

* ASP.NET Core (.NET 9 likely)
* C#
* Entity Framework Core (EF Core)
* SignalR
* Clerk (Webhook handling, token validation)
* Azure Blob Storage
* RESTful API Design

## Directory Structure (`server/`)

```
server/
├── Controllers/             # API Endpoints
│   ├── AuthController.cs
│   ├── BeaconsController.cs
│   ├── CategoriesController.cs
│   ├── ChatController.cs
│   ├── ReviewsController.cs
│   ├── TagsController.cs
│   ├── UsersController.cs
│   ├── WebhookController.cs
│   └── WeatherForecastController.cs
├── Data/                    # Database-related code
│   ├── ApplicationDbContext.cs
│   └── SeedData.cs
├── Hubs/                    # SignalR Hubs
│   └── ChatHub.cs
├── Migrations/              # EF Core Migrations
├── Models/                  # Domain Models
│   ├── Beacon.cs
│   ├── Category.cs
│   ├── Chat.cs
│   ├── ChatMessage.cs
│   ├── DTOs/                # Data Transfer Objects
│   ├── Image.cs
│   ├── ImageSet.cs
│   ├── Review.cs
│   ├── ReviewTag.cs
│   ├── Tag.cs
│   └── User.cs
├── Services/                # Business Logic
│   ├── BeaconService.cs
│   ├── CategoryService.cs
│   ├── ClerkService.cs
│   ├── IBeaconService.cs
│   ├── ICategoryService.cs
│   ├── IClerkService.cs
│   ├── IImageService.cs
│   ├── IReviewService.cs
│   ├── IUserService.cs
│   ├── ImageService.cs
│   ├── ReviewService.cs
│   └── UserService.cs
├── Util/                    # Utility Classes
│   ├── BlobServiceManager.cs
│   ├── DotEnv.cs
│   └── ImageSetManager.cs
├── appsettings.json         # Configuration
└── Program.cs               # Application Startup
```

## Core Concepts

### API Endpoints (Controllers)

* Uses ASP.NET Core Controllers to define RESTful API endpoints.
* Located in the `Controllers/` directory.
* Follows standard conventions (e.g., `[ApiController]`, `[Route("api/[controller]")]`).
* Handles HTTP requests (GET, POST, PUT, DELETE) and maps them to service layer methods.
* Uses DTOs (`Models/DTOs/`) for request and response payloads to decouple the API from the internal domain models.

### Database (Entity Framework Core)

* Uses EF Core as the Object-Relational Mapper (ORM).
* `Data/ApplicationDbContext.cs` defines the database schema (DbSets for models like `Users`, `Beacons`, `Reviews`) and relationships.
* `Migrations/` contains code-first migration files generated by `dotnet ef migrations add`. These track changes to the database schema.
* `Data/SeedData.cs` provides initial data for the database upon setup.
* Database interactions typically occur within the Service layer, using the injected `ApplicationDbContext`.

### Authentication (Clerk Integration)

* Integrates with Clerk for authentication.
* Likely validates JWTs received from the client in API requests (possibly via middleware configured in `Program.cs`).
* `ClerkService.cs` probably handles interactions with the Clerk backend API if needed.
* `WebhookController.cs` or `AuthController.cs` likely handles incoming webhooks from Clerk (e.g., user creation, updates, deletion) to keep the local user database in sync.

### Real-time Communication (SignalR Hub)

* Uses SignalR to enable real-time features, primarily chat.
* `Hubs/ChatHub.cs` defines the server-side logic for the chat, managing client connections and message broadcasting.
* SignalR endpoint is mapped in `Program.cs`.

### Service Layer

* Business logic is encapsulated within services located in the `Services/` directory.
* Follows an interface-based design (`IUserService`, `UserService`).
* Services orchestrate calls to the database (via DbContext), external services (Clerk, Azure Blob), and perform business logic operations.
* Services are registered for Dependency Injection in `Program.cs`.

### Data Transfer Objects (DTOs)

* Located in `Models/DTOs/`.
* Used as data contracts for API endpoints to prevent exposing internal domain models directly and to shape data specifically for client consumption.

### Dependency Injection

* ASP.NET Core's built-in Dependency Injection (DI) container is used heavily.
* Services (`IUserService`, `ApplicationDbContext`, etc.) are registered in `Program.cs` and injected into controllers, hubs, and other services via constructors.

### Blob Storage (Azure)

* `Util/BlobServiceManager.cs` indicates interaction with Azure Blob Storage, likely for storing user-uploaded images (profile pictures, beacon images).
* `ImageService.cs` likely utilizes `BlobServiceManager` to handle the upload, retrieval, and deletion logic for these images.

## Configuration

* `appsettings.json` and environment-specific variants (`appsettings.Development.json`) store configuration settings like logging levels.
* Sensitive information (Connection Strings, API Keys for Clerk/Azure) should be stored using User Secrets during development (`dotnet user-secrets set "Key" "Value"`) or environment variables in production. `Util/DotEnv.cs` suggests `.env` files might also be used.
* `Properties/launchSettings.json` configures development server launch profiles (ports, environment variables for local debugging).

## Database Migrations

* EF Core Code-First migrations manage database schema changes.
* To add a new migration after changing models:
  ```bash
  cd server
  dotnet ef migrations add MigrationNameDescription
  ```
* To apply migrations to the database:
  ```bash
  cd server
  dotnet ef database update
  ```

## Running the Server

* The server can typically be run directly using the .NET CLI:
  ```bash
  cd server
  dotnet run
  ```
* Or via the `pnpm dev` command from the root directory, which likely handles starting it.

??? tip "Troubleshooting Common Server Issues"

    If you encounter issues starting the server, check the following:
    
    1. **Database Connection** - Ensure your connection string is correctly set in the environment variables
    2. **Migrations** - Make sure all migrations have been applied with `dotnet ef database update`
    3. **Ports** - Check if another process is using the same port
    4. **Authentication** - Verify Clerk API keys are correctly configured

    For more detailed server logs, you can run with the Development environment:
    
    ```bash
    dotnet run --environment Development
    ```